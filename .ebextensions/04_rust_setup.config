files:
  "/tmp/install_rust.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Install Rust and Cargo
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      source $HOME/.cargo/env
      rustc --version
      cargo --version
      # Make Rust available to all users
      echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> /etc/profile
      # Make it available immediately
      export PATH="$HOME/.cargo/bin:$PATH"

commands:
  01_install_rust_dependencies:
    command: |
      yum install -y gcc gcc-c++ make openssl-devel
    ignoreErrors: false
  02_install_rust:
    command: |
      /tmp/install_rust.sh
    ignoreErrors: false
    test: "! command -v rustc"

container_commands:
  01_ensure_rust_available:
    command: |
      if [ ! -f /root/.cargo/bin/cargo ]; then
        echo "Rust not found, re-installing..."
        /tmp/install_rust.sh
      fi
      echo 'export PATH="/root/.cargo/bin:$PATH"' >> /opt/elasticbeanstalk/deployment/.env
      source /opt/elasticbeanstalk/deployment/.env
      # Verify installation
      /root/.cargo/bin/rustc --version
      /root/.cargo/bin/cargo --version
    ignoreErrors: false
  02_check_rust_location:
    command: |
      echo "Rust binary locations:"
      find / -name rustc -type f 2>/dev/null || echo "rustc not found"
      find / -name cargo -type f 2>/dev/null || echo "cargo not found"
      echo "PATH=$PATH"
    ignoreErrors: true